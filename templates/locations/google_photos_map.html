{% extends 'base.html' %}
{% load static %}
{% block title %}
  Masud's Google Photos
{% endblock %}
{% block extend_header %}
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Leaflet MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

  <!-- Leaflet AwesomeMarkers CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="{% static 'MetroFiles/leaflet.min.css' %}" />
  <!-- Metro Map 
  <link rel="alternate" type="application/rss+xml" href="https://dhakametrorail.org/route-map/index.xml" title="Dhaka Metro Rail" />
  <link type="text/css" rel="stylesheet" href="{% static 'MetroFiles/main.bundle.min.133052877df9d21fdb73a83305fe3236e29892633a76d8aa9ddf27d1f8efd65471dbd550fc2d2ead111894ad37b0d3b4a0d53c17cdee9a52ec21b73811933b8f.css' %}" integrity="sha512-EzBSh3350h/bc6gzBf4yNuKYkmM6dtiqnd8n0fjv1lRx29VQ/C0urREYlK03sNO0oNU8F83umlLsIbc4EZM7jw==" />
  <script type="text/javascript" src="{% static 'MetroFiles/appearance.min.d2141a93e5ba37a4750b20ca3e4358ce46dd489d2e0296d52937a0c2dbee8dc248af517dd06a7f7d580654b92c1d00d4fe219736c9903ad81f155aaf8400990f.js.download' %}" integrity="sha512-0hQak+W6N6R1CyDKPkNYzkbdSJ0uApbVKTegwtvujcJIr1F90Gp/fVgGVLksHQDU/iGXNsmQOtgfFVqvhACZDw=="></script>
  <script defer="" type="text/javascript" id="script-bundle" src="{% static 'MetroFiles/main.bundle.min.c086c9fd5b8521565c37d4b3855c4f256e28e551565202c537dbaad6fce47dde3bdf043a3194e3da235b58b73ac5f0c288c0a6ef63ab11c662e780b6b35867a9.js.download' %}" integrity="sha512-wIbJ/VuFIVZcN9SzhVxPJW4o5VFWUgLFN9uq1vzkfd473wQ6MZTj2iNbWLc6xfDCiMCm72OrEcZi54C2s1hnqQ==" data-copy="Copy" data-copied="Copied"></script>
  <script src="{% static 'MetroFiles/zoom.min.f592a181a15d2a5b042daa7f746c3721acf9063f8b6acd175d989129865a37d400ae0e85b640f9ad42cd98d1f8ad30931718cf8811abdcc5fcb264400d1a2b0c.js.download' %}" integrity="sha512-9ZKhgaFdKlsELap/dGw3Iaz5Bj+Las0XXZiRKYZaN9QArg6FtkD5rULNmNH4rTCTFxjPiBGr3MX8smRADRorDA=="></script>
  Metro Map  -->

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }

    #map {
      height: 750px;
      height: 85vh;
      width: 98%;
      margin: auto;
      z-index: 1;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    .controls {
      position: absolute;
      top: 80px;
      right: 20px;
      z-index: 1000;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }
    .btn_map {
      display: block;
      width: 100%;
      padding: 8px 12px;
      background: #4285f4;
      color: white;
      text-decoration: none;
      text-align: center;
      border-radius: 4px;
      margin-top: 10px;
      font-weight: bold;
    }
    #side-nav {
      position: absolute;
      top: 80px;
      left: 0;
      width: 300px;
      height: calc(100% - 80px);
      background: white;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      overflow-y: auto;
      padding: 15px;
    }
    #side-nav.open {
      transform: translateX(0);
    }
    #nav-toggle {
      position: absolute;
      top: 80px;
      left: 10px;
      z-index: 1002;
      background: white;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }
    .place-label {
      background: transparent;
      border: none;
      box-shadow: none;
      font-weight: bold;
      font-size: 11px;
      color: #333;
      text-shadow: 0 0 3px white;
    }
    #side-nav h3 {
      margin-top: 15px;
      margin-bottom: 8px;
      font-size: 1.1em;
      border-bottom: 2px solid #4285f4;
      padding-bottom: 3px;
    }
    #side-nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #side-nav li a {
      display: block;
      padding: 6px 10px;
      text-decoration: none;
      color: #333;
      border-radius: 4px;
      font-size: 0.9em;
    }
    #side-nav li a:hover {
      background-color: #f1f3f4;
      color: #4285f4;
    }
  </style>
{% endblock %}

{% block navbar %} {% include 'locations/navbar_googlephotos.html' %}{% endblock navbar %}

{% block content %}
  {% if messages %}
      <ul class="messages">
          {% for message in messages %}
              <li {% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
          {% endfor %}
      </ul>
  {% endif %}
  <div id="nav-toggle">
    <i class="fa fa-bars"></i>
  </div>

  <div id="side-nav">
    <!-- Navigation content will be dynamically generated -->
  </div>

<div class="badge badge-soft badge-success opacity-80 absolute top-20 right-2 z-50">
      <a class="item" href="#">Nos. of 
      {% if is_video %}
        Videos :
        {% else %}
        Images : 
        {% endif %}
         <span id="count" class="font-bold">{{total_place}}</span></a>
</div>
  <div id="map"></div>
{% endblock %}

{% block script %} 
  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

  <script>
    var map; // Global map variable
    var markers;
    var markerRefs = {};

    document.addEventListener('DOMContentLoaded', function() {
        const placesByType = {{ places_by_type_json|safe }};
        const placesData = {{ places_json|safe }};
        
        // Initialize Map
        map = L.map('map', {zoomControl: false}).setView([20, 0], 2);

        // Add custom zoom control to bottomright
        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);

        // Define Base Layers
        var streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        });

        var satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri'
        });

        var baseMaps = {
            "Street Map": streetMap,
            "Satellite": satelliteMap
        };

        // Add Layer Control
        L.control.layers(baseMaps, null, { position: 'bottomleft' }).addTo(map);

        // Add default layer
        streetMap.addTo(map);

        // Initialize Marker Cluster Group
        markers = L.markerClusterGroup();

        const formatter = new Intl.DateTimeFormat('bn-BD', {
            dateStyle: 'full',
            timeStyle: 'medium',
            hour12: true,
            timeZone: 'Asia/Dhaka'
        });

        // Loop through Django data and add markers
        placesData.forEach(function(place, index) {
            if (place.latitude && place.longitude) {
                var icon = L.AwesomeMarkers.icon({
                    icon: place.icon || 'camera',
                    markerColor: place.color || 'red',
                    prefix: 'fa'
                });

                var marker = L.marker([place.latitude, place.longitude], {icon: icon});
                
                var popupContent = `<div style="min-width: 250px;"><b>${place.name || "Unknown Location"}</b><br>`;
                if (place.timestamp) {
                    try {
                        let new_dt = new Date(place.timestamp);
                        popupContent += `<i>${formatter.format(new_dt)}</i><br>`;
                    } catch(e) {
                        popupContent += `<i>${place.timestamp}</i><br>`;
                    }
                }
                
                if (place.image_url) {
                    if (place.is_video) {
                        popupContent += `<video width="100%" height="auto" controls style="margin-top: 10px; border-radius: 4px;">
                            <source src="${place.image_url}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>`;
                    } else {
                        popupContent += `<a href="${place.image_url}" target="_blank">
                            <img src="${place.image_url}" style="margin: 10px auto; display: block; max-width: 100%; border-radius: 4px;" width="250px">
                        </a>`;
                    }
                }
                
                popupContent += `<hr><small><a href="https://www.google.com/maps?q=${place.latitude},${place.longitude}" target="_blank" style="color: #4285f4; text-decoration: none;">&#128279; GEO Location</a></small>`;
                
                if (place.comments) {
                    popupContent += `<br><small style="color: #666;">${place.comments}</small>`;
                }
                if (place.people) {
                    popupContent += `<br><small style="color: #4285f4; font-weight: bold;">${place.people}</small>`;
                }
                popupContent += `</div>`;
                
                marker.bindPopup(popupContent);

                if (place.name) {
                    marker.bindTooltip(place.name, {
                        permanent: false, 
                        direction: 'top',
                        offset: [0, -10],
                        className: 'place-label'
                    });
                }

                markers.addLayer(marker);
                markerRefs[place.name + '_' + index] = marker; 
            }
        });

        map.addLayer(markers);
        
        // Update stats
        const countElement = document.getElementById('count');
        if (countElement) {
            countElement.innerText = placesData.length;
        }

        // Fit bounds
        if (placesData.length > 0) {
            try {
                map.fitBounds(markers.getBounds());
            } catch(e) {
                console.error("Error fitting bounds:", e);
            }
        }

        // Side Navigation Logic
        const sideNav = document.getElementById('side-nav');
        const navToggle = document.getElementById('nav-toggle');
        
        if (navToggle && sideNav) {
            navToggle.addEventListener('click', function() {
                sideNav.classList.toggle('open');
            });

            // Populate side nav
            if (Object.keys(placesByType).length === 0 && placesData.length > 0) {
                const groupDiv = document.createElement('div');
                groupDiv.innerHTML = `<h3>All Media</h3>`;
                const placeList = document.createElement('ul');
                
                placesData.forEach(function(place, index) {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<a href="#">${place.name || "Unnamed"}</a>`;
                    listItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        const marker = markerRefs[place.name + '_' + index];
                        if (marker) {
                            markers.zoomToShowLayer(marker, function() {
                                map.setView(marker.getLatLng(), 15);
                                marker.openPopup();
                            });
                        }
                    });
                    placeList.appendChild(listItem);
                });
                groupDiv.appendChild(placeList);
                sideNav.appendChild(groupDiv);
            } else {
                let overallPlaceIndex = 0;
                for (const type in placesByType) {
                    const group = placesByType[type];
                    const groupDiv = document.createElement('div');
                    groupDiv.innerHTML = `<h3>${type}</h3>`;
                    const placeList = document.createElement('ul');

                    group.places.forEach(function(place) {
                        const placeName = place.name;
                        const currentIndex = overallPlaceIndex;
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `<a href="#">${placeName}</a>`;
                        
                        listItem.addEventListener('click', function(e) {
                            e.preventDefault();
                            const markerKey = placeName + '_' + currentIndex;
                            const marker = markerRefs[markerKey];
                            if (marker) {
                                markers.zoomToShowLayer(marker, function() {
                                    map.setView(marker.getLatLng(), 15);
                                    marker.openPopup();
                                });
                            }
                        });
                        
                        placeList.appendChild(listItem);
                        overallPlaceIndex++;
                    });
                    groupDiv.appendChild(placeList);
                    sideNav.appendChild(groupDiv);
                }
            }
        }
    });
  </script>
{% endblock script %}
