{% extends 'base.html' %}
{% load static %}
{% load mahimsoft_tags %}
{% load month_filters %}
{% block title %}
  Masud's Photo Album
{% endblock %}
{% block extend_header %}
  <style>
        /* Smooth transitions for hover effects */
        .img-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .img-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        /* Custom select styling for better appearance */
        /* select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        } */
        .video-container {
  /* Define a max-width for the container if needed */
  max-width: 800px;
  margin: auto;
}

.video {
  width: 100%;
  height: auto; /* Maintains the video's native aspect ratio */
  
  /* Auto-resizes the poster image to cover the video element's dimensions */
  object-fit: cover; 
  
  /* Ensures consistency for the poster image */
  background-size: cover; 
  background-position: 50% 50%;
  
  /* Prevents layout shift as video loads (optional but recommended) */
  aspect-ratio: 16 / 9; /* Use the aspect ratio of your video (e.g., 16:9) */
}
.popup-image {
    cursor: pointer;
    transition: opacity 0.2s;
}

.popup-image:hover {
    opacity: 0.9;
}

    </style>
{% endblock %}

    {% block navbar %}
    {% include 'locations/navbar_person_images.html' %}
    {% endblock navbar %}

{% block content %}
<div class="bg-gray-50 font-sans antialiased max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
        <!-- Header Section -->
        <header class="text-center mb-2">
            <h1 class="text-3xl font-extrabold text-gray-600 tracking-tight sm:text-4xl">
                Our Friends and Family {% if people_images.0.is_video %} Video {% else %} Photo {% endif %} Album
            </h1>
            <!-- <p class="mt-4 text-lg text-gray-600 max-w-2xl mx-auto">
                Filter by name and (optional) year/month to find friends and family members.
            </p> -->
            {% include 'includes/top_25.html' %}
                
            <div class="text-md flex justify-between items-center mt-2 bg-blue-300 rounded-md p-1 px-2">
                {% include 'includes/search_form.html' %}
                <span>
            Year: <span class="text-red-500">{% if people_images.0.photo_year %}{{people_images.0.photo_year}}{% else %}all, {% endif %}</span> Month: <span class="text-red-500">{% if people_images.0.photo_month %}{{people_images.0.photo_month|month_name}}{% else %}all{% endif %}, </span> Total 
            {% if people_images.0.is_video %}
                Videos:
                {% else %}
                Images:
            {% endif %} 
                  <span class="text-red-500">{{total_images|stringformat:"i"}}</span> 
                  </span> 
                 </div>
        </header>

        <!-- Image Grid -->
        <div id="image-grid" class="scroll-mt-10 grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
            {% for person in people_images %}
            <div class="img-card bg-white rounded-2xl overflow-hidden border border-gray-100 shadow-sm">
                <div class="aspect-w-16 aspect-h-9 relative overflow-hidden bg-gray-200">
                    {% if person.image %}
                    {% if not person.is_video %}
                    <!-- <a href="{{ person.image.url }}" title="View Image" target="_blank"> -->
                    <img id="{{person.id}}: [{{forloop.counter}}]"
                    src="{{ person.image.url }}" 
                    alt="{{ person.name|title }}" 
                    class="w-full h-[400px] object-cover popup-image"
                    srcset="{{ person.image.url|safe }}"
                    onerror="this.src='https://via.placeholder.com/800x600?text=Image+Not+Found'"
                    >
                <!-- </a> -->
                    {% else %}
                    <div class="video-container">

                        <video class="video"  poster="{{person.video_thumbnail_url}}" controls>
                            <source src="{{person.image.url}}" type="video/mp4">
                            <source src="{{person.image.url}}" type="video/webm">
                            <source src="{{person.image.url}}" type="video/ogg">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                    {% endif %}
                    {% else %}
                        <div class="w-full h-[400px] flex items-center justify-center bg-gray-200 text-gray-400">
                            <span>No Image Available</span>
                        </div>
                    {% endif %}
                    <!-- <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent flex items-end">
                        <div class="p-6 w-full flex justify-between items-end">
                            <div>
                                <h3 class="text-2xl font-bold text-white">{{ person.person_name|default:"Unknown Person"}}</h3>
                                <p class="text-gray-200 text-sm font-medium uppercase tracking-wider">
                                    {{ person.people|default:'Member' }}
                                </p>
                            </div>
                            <div class="text-right text-gray-300 text-xs font-medium">
                                Joined: {{ person.month_name|default:"--" }} {{ person.year|default:"" }}
                            </div>
                        </div>
                    </div> -->
                </div>

                <div class="p-6">
    <p class="text-gray-600 flex justify-start">
    {% if person.people %}
    <img src="{% static 'images/people.svg' %}" width="24" height="24" style="background: darksalmon; opacity: 0.6; border-radius: 5px; position: absolute;" alt="people">
    <span class="people ms-8">{{ person.people|title|color_text|default:'No description available for this person.' }}</span>
    {% endif %}
    <hr class="opacity-30 ms-8">
            </p>
            
            <p class="text-gray-600 leading-relaxed">
              <span class="photo-date">ðŸ“…: {{ person.photo_taken_time|date:"d F Y : H:i:s"|default:"No 'Image Taken Date' of  available for this image." }}</span>
              {% if person.is_location %}
                <small class="gps" style="color: red;"><a href="https://www.google.com/maps?q={{ person.latitude }},{{ person.longitude }}" title="Go to Google Maps: {{ person.latitude }}, {{ person.longitude }}" target="_blank">&#128279; GEO Location</a></small>
              {% endif %}
            </p>
            <div class="mt-6 flex items-center justify-between">
              <a href="#" class="text-indigo-600 font-semibold hover:text-indigo-800 transition-colors">View Profile &rarr;</a>
              <span class="text-xs text-gray-400">ID: #{{ person.id }} ({{ person.title }})</span>
            </div>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full py-20 text-center bg-white rounded-2xl border-2 border-dashed border-gray-200">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No matches found</h3>
                <p class="mt-1 text-sm text-gray-500">Try changing your Name, Year, or Month filters.</p>
            </div>
            {% endfor %}
        </div>
        <span class="flex justify-center items-center">
        {% include 'includes/pagination.html' %} 
        {% include 'includes/jump_to_page.html' %}
        </span>
    </div>
    {% include 'slideshow.html' %}
{% endblock %}



{% block script %}
<script>
    let currentSlideIndex = 0;
    const slides = [];

    document.addEventListener('DOMContentLoaded', function() {
        // 1. Scrape the grid for all media items
        const cards = document.querySelectorAll('.img-card');
        
        cards.forEach((card, index) => {
            const img = card.querySelector('.popup-image');
            const video = card.querySelector('video source');
            
            slides.push({
                url: img ? img.src : (video ? video.src : ''),
                isVideo: !!video,
                name: card.querySelector('.people')?.innerText || 'Gallery Item',
                gps: card.querySelector('.gps')?.innerHTML || '',
                photodate: card.querySelector('.photo-date')?.innerHTML || ''
            });

            // 2. Attach click event to the specific image or video in the grid
            const trigger = card.querySelector('.popup-image') || card.querySelector('.video');
            if (trigger) {
                trigger.style.cursor = 'pointer';
                trigger.onclick = () => openSlideshow(index);
            }
        });
    });

    function openSlideshow(index) {
        currentSlideIndex = index;
        document.getElementById('slideshow-modal').classList.remove('hidden');
        document.getElementById('slideshow-modal').classList.add('flex');
        document.body.style.overflow = 'hidden'; // Prevent scrolling
        updateSlide();
    }

    function closeSlideshow() {
        document.getElementById('slideshow-modal').classList.add('hidden');
        document.getElementById('slideshow-modal').classList.remove('flex');
        document.body.style.overflow = 'auto';
        // Stop video if playing
        document.getElementById('slideshow-video').pause();
    }

    function changeSlide(step) {
        currentSlideIndex = (currentSlideIndex + step + slides.length) % slides.length;
        updateSlide();
    }

    function updateSlide() {
        const slide = slides[currentSlideIndex];
        const imgEl = document.getElementById('slideshow-img');
        const videoEl = document.getElementById('slideshow-video');
        
        // Reset visibility
        imgEl.classList.add('hidden');
        videoEl.classList.add('hidden');
        videoEl.pause();

        if (slide.isVideo) {
            videoEl.src = slide.url;
            videoEl.classList.remove('hidden');
            videoEl.load();
        } else {
            imgEl.src = slide.url;
            imgEl.classList.remove('hidden');
        }

        // Update Info
        document.getElementById('slideshow-name').innerText = slide.name;
        document.getElementById('slideshow-count').innerHTML = `Item ${currentSlideIndex + 1} of ${slides.length} ${slide.gps}, ${slide.photodate}`;
    }

    // Keyboard support
    document.addEventListener('keydown', (e) => {
        if (document.getElementById('slideshow-modal').classList.contains('hidden')) return;
        if (e.key === "Escape") closeSlideshow();
        if (e.key === "ArrowLeft") changeSlide(-1);
        if (e.key === "ArrowRight") changeSlide(1);
    });
</script>
<script src="{% static 'js/jumpToPage.js' %}"></script>
<script>
    jumpToPageOnEnter({{ page_obj.paginator.num_pages }})
</script>
{% endblock script %}
    
