{% extends 'base.html' %}
{% load static %}
{% block title %}
  Masud's Location History
{% endblock %}
{% block extend_header %}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <!-- Leaflet AwesomeMarkers CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: sans-serif;
      }
      #map {
        height: 750px;
        height: 85vh;
        width: 98%;
        margin: auto;
        z-index: 1;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      }
      .controls {
        position: absolute;
        top: 80px;
        right: 20px;
        z-index: 1000;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      }
      #side-nav {
        position: absolute;
        top: 80px;
        left: 0;
        width: 300px;
        height: calc(100% - 80px);
        background: white;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        overflow-y: auto;
        padding: 15px;
      }
      #side-nav.open {
        transform: translateX(0);
      }
      #nav-toggle {
        position: absolute;
        top: 80px;
        left: 10px;
        z-index: 1002;
        background: white;
        padding: 10px;
        border-radius: 4px;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      }
      .place-label {
        background: transparent;
        border: none;
        box-shadow: none;
        font-weight: bold;
        font-size: 11px;
        color: #333;
        text-shadow: 0 0 3px white;
      }
      #side-nav h3 {
        margin-top: 15px;
        margin-bottom: 8px;
        font-size: 1.1em;
        border-bottom: 2px solid #4285f4;
        padding-bottom: 3px;
      }
      #side-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      #side-nav li a {
        display: block;
        padding: 6px 10px;
        text-decoration: none;
        color: #333;
        border-radius: 4px;
        font-size: 0.9em;
      }
      #side-nav li a:hover {
        background-color: #f1f3f4;
        color: #4285f4;
      }
    </style>
{% endblock %}
{% block navbar %} {% include 'locations/navbar_googlephotos.html' %}{% endblock navbar %}

{% block content %}
    <div id="nav-toggle">
      <i class="fa fa-bars"></i>
    </div>

    <div id="side-nav">
      <!-- Navigation content will be dynamically generated -->
    </div>

    <p id="customAlert"></p>
    <div class="controls">
      <div class="badge badge-soft badge-success mb-2 w-full justify-center flex">
        Total Points: <span id="count" class="font-bold ml-1">{{total_place}}</span>
      </div>
      <h3 class="text-center font-semibold mb-2">Maps Visualizer</h3>
      <a href="{% url 'locations:upload_data' %}" class="btn btn-error btn-sm w-full">Upload New Data</a>
    </div>

    <div id="map"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    
    <script>
        var map; // Global map variable
        var markers;
        var markerRefs = {};

        document.addEventListener('DOMContentLoaded', function() {
            const placesByType = {{ places_by_type_json|safe }};
            const placesData = {{ places_json|safe }};

            // Initialize Map
            map = L.map('map', {zoomControl: false}).setView([20, 0], 2);

            // Add custom zoom control to bottomright
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);

            // Define Base Layers
            var streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            });

            var satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri'
            });

            var baseMaps = {
                "Street Map": streetMap,
                "Satellite": satelliteMap
            };

            // Add Layer Control
            L.control.layers(baseMaps, null, { position: 'bottomleft' }).addTo(map);

            // Add default layer
            streetMap.addTo(map);

            // Initialize Marker Cluster Group
            markers = L.markerClusterGroup();
            
            const formatter = new Intl.DateTimeFormat('bn-BD', {
                dateStyle: 'full',
                timeStyle: 'medium',
                hour12: true,
                timeZone: 'Asia/Dhaka'
            });

            // Loop through Django data and add markers
            placesData.forEach(function(place, index) {
                if (place.latitude && place.longitude) {
                    var icon = L.AwesomeMarkers.icon({
                        icon: place.icon || 'info-circle',
                        markerColor: place.color || 'blue',
                        prefix: 'fa'
                    });

                    var marker = L.marker([place.latitude, place.longitude], {icon: icon});
                    
                    var popupContent = `<div style="min-width: 200px;"><b>${place.name || "Unknown Location"}</b><br>`;
                    if (place.timestamp) {
                        try {
                            let new_dt = new Date(place.timestamp);
                            popupContent += `<i>${formatter.format(new_dt)}</i><br>`;
                        } catch(e) {
                            popupContent += `<i>${place.timestamp}</i><br>`;
                        }
                    }
                    if (place.address) {
                        popupContent += `<small>${place.address}</small><br>`;
                    }
                    popupContent += `<hr><small><a href="https://www.google.com/maps?q=${place.latitude},${place.longitude}" target="_blank" style="color: #4285f4; text-decoration: none;">&#128279; GEO Location</a></small></div>`;
                    
                    marker.bindPopup(popupContent);

                    if (place.name) {
                        marker.bindTooltip(place.name, {
                            permanent: false, 
                            direction: 'top',
                            offset: [0, -10],
                            className: 'place-label'
                        });
                    }

                    markers.addLayer(marker);
                    markerRefs[place.name + '_' + index] = marker; 
                }
            });

            map.addLayer(markers);
            
            // Update stats
            const countElement = document.getElementById('count');
            if (countElement) {
                countElement.innerText = placesData.length;
            }

            // Fit bounds
            if (placesData.length > 0) {
                try {
                    map.fitBounds(markers.getBounds());
                } catch(e) {
                    console.error("Error fitting bounds:", e);
                }
            }

            // Side Navigation Logic
            const sideNav = document.getElementById('side-nav');
            const navToggle = document.getElementById('nav-toggle');
            
            if (navToggle && sideNav) {
                navToggle.addEventListener('click', function() {
                    sideNav.classList.toggle('open');
                });

                // Populate side nav
                let overallPlaceIndex = 0;
                for (const type in placesByType) {
                    const group = placesByType[type];
                    const groupDiv = document.createElement('div');
                    groupDiv.innerHTML = `<h3>${type}</h3>`;
                    const placeList = document.createElement('ul');

                    group.places.forEach(function(place) {
                        const placeName = place.name;
                        const currentIndex = overallPlaceIndex;
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `<a href="#">${placeName}</a>`;
                        
                        listItem.addEventListener('click', function(e) {
                            e.preventDefault();
                            const markerKey = placeName + '_' + currentIndex;
                            const marker = markerRefs[markerKey];
                            if (marker) {
                                markers.zoomToShowLayer(marker, function() {
                                    map.setView(marker.getLatLng(), 15);
                                    marker.openPopup();
                                });
                            }
                        });
                        
                        placeList.appendChild(listItem);
                        overallPlaceIndex++;
                    });
                    groupDiv.appendChild(placeList);
                    sideNav.appendChild(groupDiv);
                }
            }
        });
    </script>
{% endblock %}
